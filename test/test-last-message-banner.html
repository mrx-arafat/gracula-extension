<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Last Message with E2E Banner</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .message { padding: 8px; margin: 5px 0; background: #f0f0f0; border-radius: 5px; }
        .system-banner { background: #fff3cd; border-left: 4px solid #ffc107; }
        .result { padding: 10px; margin: 10px 0; background: #d4edda; border-radius: 5px; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Test: Last Message Detection with E2E Banner</h1>
    
    <div class="test-section">
        <h2>Conversation Messages</h2>
        <div id="messages-display"></div>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script>
        // Simulate the conversation from the user's example
        window.testMessages = [
            {
                speaker: 'Shohan Shovo CSE 21',
                text: 'Ai hoilo card er obstha vai',
                timestamp: new Date('2025-11-23T10:00:00'),
                isOutgoing: false
            },
            {
                speaker: 'Shohan Shovo CSE 21',
                text: '-3$ houar karone ar payment kori nah.. Card falaia raxi..',
                timestamp: new Date('2025-11-23T10:05:00'),
                isOutgoing: false
            },
            {
                speaker: 'You',
                text: 'ami card e 10 dollar er beshi rakhi na',
                timestamp: new Date('2025-11-23T10:10:00'),
                isOutgoing: true
            },
            {
                speaker: 'You',
                text: 'vorle kete nibe',
                timestamp: new Date('2025-11-23T10:15:00'),
                isOutgoing: true
            },
            {
                speaker: 'Shohan Shovo CSE 21',
                text: 'Ji vai ejnnoi card bad dia dsi.. Onk manisher kase details ase.. Ke je kun jaygay service add koira rakhse khali payment request ashe.. Abr declination er o fee ase [reactions: ðŸ˜¢]',
                timestamp: new Date('2025-11-23T10:20:00'),
                isOutgoing: false
            },
            {
                speaker: 'Other',
                text: 'Messages and calls are end-to-end encrypted. Only people in this chat can read, listen to, or share them. Click to learn more',
                timestamp: new Date('2025-11-23T10:21:00'),
                isOutgoing: false,
                isSystemBanner: true
            }
        ];

        // Display messages
        const messagesDisplay = document.getElementById('messages-display');
        window.testMessages.forEach((msg, idx) => {
            const div = document.createElement('div');
            div.className = `message ${msg.isSystemBanner ? 'system-banner' : ''}`;
            div.innerHTML = `
                <strong>${msg.speaker}</strong> (${msg.timestamp.toLocaleTimeString()}):
                <br/>${msg.text}
                ${msg.isSystemBanner ? '<br/><em>[SYSTEM BANNER]</em>' : ''}
            `;
            messagesDisplay.appendChild(div);
        });

        // Test the filtering logic
        function testLastMessageDetection() {
            const results = document.getElementById('results');
            results.innerHTML = '';

            // Test 1: Check total messages
            const totalMessages = window.testMessages.length;
            const test1 = document.createElement('div');
            test1.className = 'result';
            test1.innerHTML = `<strong>Test 1: Total Messages</strong><br/>Count: ${totalMessages}<br/>âœ“ PASS`;
            results.appendChild(test1);

            // Test 2: Filter system banners
            const isSystemNotice = (text) => {
                if (!text || typeof text !== 'string') return false;
                const normalized = text.replace(/\s+/g, ' ').trim().toLowerCase();
                const e2eBannerCore = 'messages and calls are end-to-end encrypted.';
                const e2eBannerTailPhrases = [
                    'only people in this chat can read, listen to, or share them. click to learn more',
                    'only people in this group can read, listen to, or share them. click to learn more'
                ];
                
                if (normalized.includes(e2eBannerCore)) {
                    const hasTail = e2eBannerTailPhrases.some(phrase => normalized.includes(phrase));
                    if (hasTail) return true;
                }
                
                if (normalized.includes('secured with end-to-end encryption')) {
                    if (normalized.includes('tap for more info') || normalized.includes('click to learn more')) {
                        return true;
                    }
                }
                
                return false;
            };

            const nonSystemMessages = window.testMessages.filter(m => !isSystemNotice(m.text));
            const test2 = document.createElement('div');
            test2.className = 'result';
            test2.innerHTML = `<strong>Test 2: Filter System Banners</strong><br/>Non-system messages: ${nonSystemMessages.length}<br/>âœ“ PASS`;
            results.appendChild(test2);

            // Test 3: Get last non-system message
            const lastMessage = nonSystemMessages[nonSystemMessages.length - 1];
            const test3 = document.createElement('div');
            test3.className = lastMessage && lastMessage.text.includes('card bad dia dsi') ? 'result' : 'result error';
            test3.innerHTML = `
                <strong>Test 3: Last Non-System Message</strong><br/>
                Speaker: ${lastMessage?.speaker}<br/>
                Text: ${lastMessage?.text.substring(0, 50)}...<br/>
                ${lastMessage && lastMessage.text.includes('card bad dia dsi') ? 'âœ“ PASS' : 'âœ— FAIL'}
            `;
            results.appendChild(test3);

            // Test 4: Verify banner is NOT the last message
            const bannerIsLast = window.testMessages[window.testMessages.length - 1].isSystemBanner;
            const test4 = document.createElement('div');
            test4.className = !bannerIsLast ? 'result' : 'result error';
            test4.innerHTML = `
                <strong>Test 4: Banner is NOT Last Message</strong><br/>
                Banner is last in raw list: ${bannerIsLast}<br/>
                After filtering, last is: ${lastMessage?.speaker}<br/>
                ${!bannerIsLast || (lastMessage && lastMessage.text.includes('card bad dia dsi')) ? 'âœ“ PASS' : 'âœ— FAIL'}
            `;
            results.appendChild(test4);
        }

        // Run tests on page load
        window.addEventListener('load', testLastMessageDetection);
    </script>
</body>
</html>

