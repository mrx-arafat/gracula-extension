<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Autocomplete Click Handler</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-container {
      border: 2px solid #667eea;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .test-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      margin: 10px 0;
    }
    .test-input[contenteditable="true"] {
      min-height: 50px;
      background: #f9f9f9;
    }
    .test-result {
      background: #f0f0f0;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .log-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 2px 0;
      padding: 2px 0;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #5568d3;
    }
    h2 {
      color: #667eea;
    }
  </style>
</head>
<body>
  <h1>üß™ Autocomplete Click Handler Test</h1>

  <div class="test-container">
    <h2>Test 1: Verify Classes Load</h2>
    <button onclick="testClassesLoad()">Run Test</button>
    <div id="test1-result" class="test-result"></div>
  </div>

  <div class="test-container">
    <h2>Test 2: Create Dropdown with Callback</h2>
    <button onclick="testDropdownCreation()">Run Test</button>
    <div id="test2-result" class="test-result"></div>
  </div>

  <div class="test-container">
    <h2>Test 3: Simulate Click Flow</h2>
    <div contenteditable="true" class="test-input" id="test-input">Type "hello" here</div>
    <button onclick="testClickFlow()">Show Suggestions</button>
    <button onclick="simulateClick()">Simulate Click on First Suggestion</button>
    <div id="test3-result" class="test-result"></div>
  </div>

  <div class="test-container">
    <h2>Test 4: Complete Integration Test</h2>
    <button onclick="testFullIntegration()">Run Full Integration Test</button>
    <div id="test4-result" class="test-result"></div>
  </div>

  <div class="test-container">
    <h2>Console Logs</h2>
    <button onclick="clearLogs()">Clear Logs</button>
    <div id="console-logs" class="log-output"></div>
  </div>

  <!-- Load Extension Scripts -->
  <script src="../src/widgets/autocomplete/ui/AutocompleteDropdown.js"></script>
  <script src="../src/widgets/autocomplete/model/AutocompleteManager.js"></script>

  <script>
    // Capture console logs
    const logs = [];
    const originalLog = console.log;
    const originalError = console.error;

    console.log = function(...args) {
      logs.push({ type: 'log', message: args.join(' '), time: new Date().toLocaleTimeString() });
      updateLogDisplay();
      originalLog.apply(console, args);
    };

    console.error = function(...args) {
      logs.push({ type: 'error', message: args.join(' '), time: new Date().toLocaleTimeString() });
      updateLogDisplay();
      originalError.apply(console, args);
    };

    function updateLogDisplay() {
      const logContainer = document.getElementById('console-logs');
      logContainer.innerHTML = logs.map(log => {
        const color = log.type === 'error' ? '#ff6b6b' : '#d4d4d4';
        return `<div class="log-entry" style="color: ${color}">[${log.time}] ${log.message}</div>`;
      }).join('');
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function clearLogs() {
      logs.length = 0;
      updateLogDisplay();
    }

    // Test 1: Verify classes load
    function testClassesLoad() {
      const result = document.getElementById('test1-result');

      if (!window.Gracula) {
        result.innerHTML = '<span class="error">‚ùå FAILED: window.Gracula not found</span>';
        return;
      }

      if (!window.Gracula.AutocompleteDropdown) {
        result.innerHTML = '<span class="error">‚ùå FAILED: AutocompleteDropdown class not found</span>';
        return;
      }

      if (!window.Gracula.AutocompleteManager) {
        result.innerHTML = '<span class="error">‚ùå FAILED: AutocompleteManager class not found</span>';
        return;
      }

      result.innerHTML = '<span class="success">‚úÖ PASSED: All classes loaded successfully</span>';
      console.log('‚úÖ Test 1 passed: Classes loaded');
    }

    // Test 2: Create dropdown with callback
    let testDropdown = null;
    let callbackTriggered = false;
    let callbackValue = null;

    function testDropdownCreation() {
      const result = document.getElementById('test2-result');
      callbackTriggered = false;
      callbackValue = null;

      try {
        testDropdown = new window.Gracula.AutocompleteDropdown({
          onSelect: (suggestion) => {
            console.log('üî• Test callback triggered with:', suggestion);
            callbackTriggered = true;
            callbackValue = suggestion;
          }
        });

        // Test if callback is set
        if (typeof testDropdown.onSelect !== 'function') {
          result.innerHTML = '<span class="error">‚ùå FAILED: onSelect is not a function</span>';
          return;
        }

        // Test calling the callback
        testDropdown.onSelect('test suggestion');

        if (callbackTriggered && callbackValue === 'test suggestion') {
          result.innerHTML = '<span class="success">‚úÖ PASSED: Dropdown created and callback works</span>';
          console.log('‚úÖ Test 2 passed: Callback working');
        } else {
          result.innerHTML = '<span class="error">‚ùå FAILED: Callback not triggered or wrong value</span>';
        }
      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå FAILED: ${error.message}</span>`;
        console.error('Test 2 error:', error);
      }
    }

    // Test 3: Simulate click flow
    let testManager = null;
    let insertCalled = false;
    let insertedValue = null;

    function testClickFlow() {
      const result = document.getElementById('test3-result');
      const input = document.getElementById('test-input');

      try {
        // Create manager with mock
        testManager = {
          inputField: input,
          insertSuggestion: function(suggestion) {
            console.log('üî•üî•üî• insertSuggestion called with:', suggestion);
            insertCalled = true;
            insertedValue = suggestion;

            // Actually insert the text
            input.innerHTML = '';
            input.textContent = suggestion;
          }
        };

        // Create dropdown with callback to manager
        const dropdown = new window.Gracula.AutocompleteDropdown({
          onSelect: (suggestion) => {
            console.log('üî• Dropdown callback triggered');
            if (testManager && typeof testManager.insertSuggestion === 'function') {
              testManager.insertSuggestion(suggestion);
            }
          }
        });

        // Show dropdown with suggestions
        dropdown.show(['hello, how are you?', 'hello there!', 'hello, what\'s up?'], input);

        result.innerHTML = '<span class="success">‚úÖ Dropdown shown with suggestions. Click "Simulate Click" button.</span>';
        console.log('‚úÖ Dropdown shown');

        // Store for next test
        window.testDropdown = dropdown;

      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå FAILED: ${error.message}</span>`;
        console.error('Test 3 error:', error);
      }
    }

    function simulateClick() {
      const result = document.getElementById('test3-result');
      insertCalled = false;
      insertedValue = null;

      if (!window.testDropdown) {
        result.innerHTML = '<span class="error">‚ùå Run "Show Suggestions" first</span>';
        return;
      }

      try {
        // Simulate clicking first suggestion
        console.log('üëÜ Simulating click on first suggestion...');
        window.testDropdown.selectCurrent();

        // Wait a bit for async operations
        setTimeout(() => {
          const input = document.getElementById('test-input');
          const actualText = input.textContent || input.innerText;

          console.log('Checking results...');
          console.log('insertCalled:', insertCalled);
          console.log('insertedValue:', insertedValue);
          console.log('Actual input text:', actualText);

          if (insertCalled && insertedValue && actualText === insertedValue) {
            result.innerHTML = `<span class="success">‚úÖ PASSED: Click handler works! Text inserted: "${actualText}"</span>`;
            console.log('‚úÖ Test 3 passed: Click handler working');
          } else {
            result.innerHTML = `<span class="error">‚ùå FAILED: insertCalled=${insertCalled}, insertedValue="${insertedValue}", actualText="${actualText}"</span>`;
          }
        }, 100);

      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå FAILED: ${error.message}</span>`;
        console.error('Simulate click error:', error);
      }
    }

    // Test 4: Full integration test
    function testFullIntegration() {
      const result = document.getElementById('test4-result');
      result.innerHTML = 'Running integration test...';

      console.log('üß™ Starting full integration test...');

      try {
        // Step 1: Create input
        const testInput = document.createElement('div');
        testInput.contentEditable = 'true';
        testInput.textContent = 'hello';
        testInput.style.cssText = 'padding: 10px; border: 1px solid #ddd; margin: 10px 0;';

        let insertionWorked = false;
        let finalText = '';

        // Step 2: Create manager
        const manager = {
          inputField: testInput,
          insertSuggestion: function(suggestion) {
            console.log('üî• Manager insertSuggestion called:', suggestion);

            // Clear input
            this.inputField.innerHTML = '';
            this.inputField.textContent = '';

            // Insert suggestion
            const textNode = document.createTextNode(suggestion);
            this.inputField.appendChild(textNode);

            finalText = this.inputField.textContent;
            insertionWorked = true;

            console.log('‚úÖ Insertion complete. Text:', finalText);
          }
        };

        // Step 3: Create dropdown
        const dropdown = new window.Gracula.AutocompleteDropdown({
          onSelect: (suggestion) => {
            console.log('üî• Dropdown onSelect called:', suggestion);
            manager.insertSuggestion(suggestion);
          }
        });

        // Step 4: Show dropdown
        dropdown.show(['hello, how are you?', 'hello there!'], testInput);

        // Step 5: Simulate click
        console.log('üëÜ Simulating click...');
        dropdown.selectCurrent();

        // Step 6: Verify
        setTimeout(() => {
          console.log('Verifying results...');
          console.log('Insertion worked?', insertionWorked);
          console.log('Final text:', finalText);

          if (insertionWorked && finalText === 'hello, how are you?') {
            result.innerHTML = `<span class="success">‚úÖ PASSED: Full integration test successful! Final text: "${finalText}"</span>`;
            console.log('‚úÖ Test 4 passed: Full integration working');
          } else {
            result.innerHTML = `<span class="error">‚ùå FAILED: insertionWorked=${insertionWorked}, finalText="${finalText}"</span>`;
          }
        }, 100);

      } catch (error) {
        result.innerHTML = `<span class="error">‚ùå FAILED: ${error.message}</span>`;
        console.error('Integration test error:', error);
      }
    }

    // Auto-run Test 1 on load
    window.addEventListener('load', () => {
      console.log('üß™ Test page loaded');
      testClassesLoad();
    });
  </script>
</body>
</html>
