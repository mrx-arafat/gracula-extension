<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gracula Modal Test - New Layout</title>

    <!-- Load styles -->
    <link rel="stylesheet" href="../src/styles.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .test-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .console-log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .console-log div {
            margin: 5px 0;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.pass {
            background: #10b981;
            color: white;
        }

        .status.fail {
            background: #ef4444;
            color: white;
        }

        .status.pending {
            background: #f59e0b;
            color: white;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>🧛 Gracula Modal Test - New Layout</h1>
        <p>This test file checks if the new three-column modal layout works correctly.</p>

        <button class="test-button" onclick="runTests()">🧪 Run All Tests</button>
        <button class="test-button" onclick="openModal()">🧛 Open Modal</button>
        <button class="test-button" onclick="testToneClick()">🎭 Test Tone Click</button>
        <button class="test-button" onclick="clearConsole()">🗑️ Clear Console</button>

        <div id="test-results" style="margin-top: 20px;"></div>
        <div id="console-output" class="console-log"></div>
    </div>

    <!-- Load all Gracula scripts in order -->
    <script src="../src/shared/utils/logger.js"></script>
    <script src="../src/shared/utils/dom.js"></script>
    <script src="../src/shared/config/tones.js"></script>
    <script src="../src/entities/tone/Tone.js"></script>
    <script src="../src/entities/message/Message.js"></script>
    <script src="../src/widgets/modal/ui/Modal.js"></script>
    <script src="../src/widgets/tone-selector/ui/ToneSelector.js"></script>
    <script src="../src/widgets/reply-list/ui/ReplyList.js"></script>

    <script>
        // Custom console override to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = [];

        function addToConsole(message, type = 'log') {
            consoleOutput.push({ message, type, time: new Date().toISOString().split('T')[1] });
            const consoleDiv = document.getElementById('console-output');
            const color = type === 'error' ? '#ff4444' : type === 'warn' ? '#ffaa00' : '#00ff00';
            consoleDiv.innerHTML += `<div style="color: ${color}">[${consoleOutput.length}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        function clearConsole() {
            consoleOutput.length = 0;
            document.getElementById('console-output').innerHTML = '';
            console.log('Console cleared');
        }

        // Test data
        const mockContext = [
            "Friend: Hey! How are you doing?",
            "You: I'm good, thanks! How about you?",
            "Friend: Pretty good! Want to grab lunch tomorrow?",
            "You: That sounds great!",
            "Friend: Cool! How about 12pm at the usual place?"
        ];

        const mockEnhancedContext = {
            analysis: {
                topics: ["lunch", "meeting", "plans"],
                sentiment: "positive",
                urgency: "low",
                languages: ["English"]
            },
            summary: {
                userName: "You"
            },
            messages: mockContext.map(msg => ({
                text: msg,
                sender: msg.startsWith("You:") ? "You" : "Friend",
                timestamp: Date.now()
            }))
        };

        let testModal = null;
        let testToneSelector = null;
        let testReplyList = null;

        function updateTestStatus(test, status) {
            const resultsDiv = document.getElementById('test-results');
            const statusClass = status === 'pass' ? 'pass' : status === 'fail' ? 'fail' : 'pending';
            const statusText = status === 'pass' ? '✅ PASS' : status === 'fail' ? '❌ FAIL' : '⏳ PENDING';
            resultsDiv.innerHTML += `<div>${test}: <span class="status ${statusClass}">${statusText}</span></div>`;
        }

        function runTests() {
            console.log('════════════════════════════════════════');
            console.log('🧪 STARTING GRACULA MODAL TESTS');
            console.log('════════════════════════════════════════');

            document.getElementById('test-results').innerHTML = '<h3>Test Results:</h3>';

            // Test 1: Check if scripts loaded
            console.log('\n📦 Test 1: Checking if scripts loaded...');
            const scriptsLoaded =
                typeof window.Gracula !== 'undefined' &&
                typeof window.Gracula.Modal !== 'undefined' &&
                typeof window.Gracula.ToneSelector !== 'undefined' &&
                typeof window.Gracula.ReplyList !== 'undefined' &&
                typeof window.Gracula.Config !== 'undefined' &&
                typeof window.Gracula.Config.TONES !== 'undefined';

            if (scriptsLoaded) {
                console.log('✅ All scripts loaded successfully');
                console.log(`   - Gracula: ${typeof window.Gracula}`);
                console.log(`   - Modal: ${typeof window.Gracula.Modal}`);
                console.log(`   - ToneSelector: ${typeof window.Gracula.ToneSelector}`);
                console.log(`   - ReplyList: ${typeof window.Gracula.ReplyList}`);
                console.log(`   - Tones: ${window.Gracula.Config.TONES.length} tones loaded`);
                updateTestStatus('Scripts Loaded', 'pass');
            } else {
                console.error('❌ Scripts not loaded properly!');
                updateTestStatus('Scripts Loaded', 'fail');
                return;
            }

            // Test 2: Create components
            console.log('\n🔧 Test 2: Creating components...');
            try {
                testToneSelector = new window.Gracula.ToneSelector({
                    onToneSelect: (tone) => {
                        console.log(`🎭 Tone selected: ${tone.name}`);
                        simulateReplyGeneration(tone);
                    }
                });

                testReplyList = new window.Gracula.ReplyList({
                    onInsert: (reply) => {
                        console.log(`✓ Insert clicked: ${reply}`);
                    },
                    onCopy: (reply) => {
                        console.log(`📋 Copy clicked: ${reply}`);
                    }
                });

                console.log('✅ Components created successfully');
                updateTestStatus('Components Created', 'pass');
            } catch (error) {
                console.error('❌ Error creating components:', error);
                updateTestStatus('Components Created', 'fail');
                return;
            }

            // Test 3: Render components
            console.log('\n🎨 Test 3: Rendering components...');
            try {
                const toneSelectorHTML = testToneSelector.render();
                const replyListHTML = testReplyList.render();

                if (toneSelectorHTML && toneSelectorHTML.includes('gracula-tone-selector')) {
                    console.log('✅ ToneSelector rendered');
                } else {
                    throw new Error('ToneSelector HTML invalid');
                }

                if (replyListHTML && replyListHTML.includes('gracula-replies-container')) {
                    console.log('✅ ReplyList rendered');
                } else {
                    throw new Error('ReplyList HTML invalid');
                }

                updateTestStatus('Components Rendered', 'pass');
            } catch (error) {
                console.error('❌ Error rendering components:', error);
                updateTestStatus('Components Rendered', 'fail');
                return;
            }

            // Test 4: Open modal
            console.log('\n🪟 Test 4: Opening modal...');
            setTimeout(() => {
                try {
                    openModal();
                    updateTestStatus('Modal Opened', 'pass');
                } catch (error) {
                    console.error('❌ Error opening modal:', error);
                    updateTestStatus('Modal Opened', 'fail');
                }
            }, 1000);

            console.log('\n════════════════════════════════════════');
            console.log('✅ Tests completed! Check results above.');
            console.log('════════════════════════════════════════');
        }

        function renderModeCards(selectedMode) {
            return `
                <div class="gracula-mode-cards">
                    <div class="gracula-mode-card ${selectedMode === 'reply_last' ? 'active' : ''}" data-mode="reply_last">
                        <div class="gracula-mode-card-header">
                            <span class="gracula-mode-card-icon">📝</span>
                            <h3 class="gracula-mode-card-title">Reply to Last Message</h3>
                        </div>
                        <p class="gracula-mode-card-description">
                            Reply to the absolute last message in the conversation.
                        </p>
                        <div class="gracula-mode-card-meta">
                            <span class="gracula-mode-card-meta-icon">💬</span>
                            <span>${mockContext.length} messages in context</span>
                        </div>
                    </div>

                    <div class="gracula-mode-card ${selectedMode === 'reply_friend' ? 'active' : ''}" data-mode="reply_friend">
                        <div class="gracula-mode-card-header">
                            <span class="gracula-mode-card-icon">👥</span>
                            <h3 class="gracula-mode-card-title">Reply to Friend</h3>
                        </div>
                        <p class="gracula-mode-card-description">
                            Reply only to your friend's messages. Your own messages are filtered out.
                        </p>
                        <div class="gracula-mode-card-meta">
                            <span class="gracula-mode-card-meta-icon">✨</span>
                            <span>Best for 1-on-1 chats</span>
                        </div>
                    </div>

                    <div class="gracula-mode-card ${selectedMode === 'new_conversation' ? 'active' : ''}" data-mode="new_conversation">
                        <div class="gracula-mode-card-header">
                            <span class="gracula-mode-card-icon">🎬</span>
                            <h3 class="gracula-mode-card-title">Start New Topic</h3>
                        </div>
                        <p class="gracula-mode-card-description">
                            Start a completely fresh conversation with a new topic.
                        </p>
                        <div class="gracula-mode-card-meta">
                            <span class="gracula-mode-card-meta-icon">🔄</span>
                            <span>Change the subject</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContextInsights() {
            return `
                <div class="gracula-context-insights">
                    <h3 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #111827;">
                        📊 Context Insights
                    </h3>

                    <div class="gracula-insight-card">
                        <div class="gracula-insight-header">
                            <span class="gracula-insight-icon">💬</span>
                            <span>Topics Discussed</span>
                        </div>
                        <div class="gracula-insight-content">
                            <div class="gracula-topic-pills">
                                <span class="gracula-topic-pill">💡 lunch</span>
                                <span class="gracula-topic-pill">💡 meeting</span>
                                <span class="gracula-topic-pill">💡 plans</span>
                            </div>
                        </div>
                    </div>

                    <div class="gracula-insight-card">
                        <div class="gracula-insight-header">
                            <span class="gracula-insight-icon">😊</span>
                            <span>Conversation Tone</span>
                        </div>
                        <div class="gracula-insight-content">
                            <div style="font-size: 12px; margin-bottom: 8px; color: #6b7280;">Positive</div>
                            <div class="gracula-sentiment-meter">
                                <div class="gracula-sentiment-bar">
                                    <div class="gracula-sentiment-indicator" style="left: 80%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="gracula-insight-card">
                        <div class="gracula-insight-header">
                            <span class="gracula-insight-icon">⚡</span>
                            <span>Urgency Level</span>
                        </div>
                        <div class="gracula-insight-content">
                            <div class="gracula-urgency-level">
                                <div class="gracula-urgency-dot active"></div>
                                <div class="gracula-urgency-dot"></div>
                                <div class="gracula-urgency-dot"></div>
                            </div>
                            <div style="font-size: 11px; margin-top: 6px; color: #6b7280;">Low priority</div>
                        </div>
                    </div>

                    <div class="gracula-insight-card">
                        <div class="gracula-insight-header">
                            <span class="gracula-insight-icon">📊</span>
                            <span>Conversation Stats</span>
                        </div>
                        <div class="gracula-insight-content">
                            <div style="font-size: 12px; color: #6b7280;">${mockContext.length} messages analyzed</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function openModal() {
            console.log('🪟 Opening modal...');

            // Close existing modal
            if (testModal) {
                testModal.close();
            }

            // Create modal content
            const content = {
                modeTabs: renderModeCards('reply_friend'),
                toneSelector: testToneSelector.render(),
                replyList: testReplyList.render(),
                contextPanel: renderContextInsights()
            };

            console.log('📦 Modal content prepared:', {
                modeTabs: content.modeTabs ? 'OK' : 'MISSING',
                toneSelector: content.toneSelector ? 'OK' : 'MISSING',
                replyList: content.replyList ? 'OK' : 'MISSING',
                contextPanel: content.contextPanel ? 'OK' : 'MISSING'
            });

            // Create and render modal
            testModal = new window.Gracula.Modal({
                onClose: () => {
                    console.log('Modal closed');
                }
            });

            testModal.render(content, { newLayout: true });
            console.log('✅ Modal rendered');

            // CRITICAL: Wait for DOM to be ready
            setTimeout(() => {
                // Attach listeners
                const modalBody = testModal.getBody();
                if (modalBody) {
                    console.log('📍 Modal body found, attaching listeners...');
                    testToneSelector.attachListeners(modalBody);
                    console.log('✅ Listeners attached');

                    // Debug: Check if buttons exist
                    const buttons = modalBody.querySelectorAll('.gracula-tone-btn-compact');
                    console.log(`🔍 Found ${buttons.length} tone buttons in DOM`);

                    if (buttons.length > 0) {
                        console.log('✅ Buttons are in the DOM and listeners should work!');
                    } else {
                        console.error('❌ No buttons found in DOM!');
                    }
                } else {
                    console.error('❌ Modal body not found!');
                }
            }, 100);
        }

        function testToneClick() {
            console.log('🎭 Testing tone click...');
            const toneBtns = document.querySelectorAll('.gracula-tone-btn-compact');
            console.log(`Found ${toneBtns.length} tone buttons`);

            if (toneBtns.length > 0) {
                console.log('Clicking first tone button...');
                toneBtns[0].click();
            } else {
                console.error('❌ No tone buttons found! Open modal first.');
            }
        }

        function simulateReplyGeneration(tone) {
            console.log(`\n🤖 Simulating reply generation for tone: ${tone.name}`);

            const modalBody = testModal.getBody();
            if (!modalBody) {
                console.error('❌ Modal body not found!');
                return;
            }

            // Show loading
            console.log('⏳ Showing loading state...');
            const loading = modalBody.querySelector('.gracula-loading');
            if (loading) {
                loading.style.display = 'block';
                console.log('✅ Loading visible');
            }

            // Simulate API delay
            setTimeout(() => {
                const mockReplies = [
                    `Sure! 12pm works perfectly for me. See you there! 😊`,
                    `Sounds good! I'll be there at noon.`,
                    `Perfect! Looking forward to it. 👍`
                ];

                console.log(`✅ Generated ${mockReplies.length} replies`);
                console.log('📝 Displaying replies...');

                testReplyList.displayReplies(mockReplies, modalBody);
                console.log('✅ Replies displayed!');
            }, 1500);
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            console.log('🚀 Test page loaded. Click "Run All Tests" to start.');
        });
    </script>
</body>
</html>
