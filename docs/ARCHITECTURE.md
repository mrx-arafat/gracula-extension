# ğŸ—ï¸ Gracula Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GRACULA EXTENSION                        â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   manifest.json â”‚  â”‚   config.js    â”‚  â”‚   styles.css     â”‚ â”‚
â”‚  â”‚   (Config)     â”‚  â”‚   (Settings)   â”‚  â”‚   (UI Styles)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    CONTENT SCRIPT                          â”‚ â”‚
â”‚  â”‚                    (content.js)                            â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â€¢ Detect messaging platform                              â”‚ â”‚
â”‚  â”‚  â€¢ Find input fields                                      â”‚ â”‚
â”‚  â”‚  â€¢ Inject floating button                                 â”‚ â”‚
â”‚  â”‚  â€¢ Extract conversation context                           â”‚ â”‚
â”‚  â”‚  â€¢ Display modal with tones                               â”‚ â”‚
â”‚  â”‚  â€¢ Insert generated replies                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â†•                                     â”‚
â”‚                    (Chrome Messages)                             â”‚
â”‚                            â†•                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  BACKGROUND SCRIPT                         â”‚ â”‚
â”‚  â”‚                  (background.js)                           â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â€¢ Handle API calls                                       â”‚ â”‚
â”‚  â”‚  â€¢ Build AI prompts                                       â”‚ â”‚
â”‚  â”‚  â€¢ Parse responses                                        â”‚ â”‚
â”‚  â”‚  â€¢ Manage settings                                        â”‚ â”‚
â”‚  â”‚  â€¢ Provide fallback replies                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â†•                                     â”‚
â”‚                      (HTTP Request)                              â”‚
â”‚                            â†•                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    POPUP INTERFACE                         â”‚ â”‚
â”‚  â”‚                (popup.html + popup.js)                     â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â€¢ Settings configuration                                  â”‚ â”‚
â”‚  â”‚  â€¢ API key management                                     â”‚ â”‚
â”‚  â”‚  â€¢ Model selection                                        â”‚ â”‚
â”‚  â”‚  â€¢ Help & documentation                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
                    (API Request)
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HUGGING FACE API                              â”‚
â”‚                                                                  â”‚
â”‚  â€¢ Mistral 7B (default)                                         â”‚
â”‚  â€¢ Llama 2 7B                                                   â”‚
â”‚  â€¢ Flan-T5 Large                                                â”‚
â”‚  â€¢ Falcon 7B                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Interaction Flow

### 1. Page Load & Initialization

```
User Opens Messaging Platform
        â†“
Chrome Loads Extension
        â†“
Content Script Injected
        â†“
Platform Detection
        â†“
Input Field Monitoring Starts
```

### 2. Button Injection

```
Input Field Detected
        â†“
Create Floating Button Element
        â†“
Position Near Input Field
        â†“
Attach Event Listeners
        â†“
Button Visible on Focus
```

### 3. Reply Generation Flow

```
User Clicks Floating Button
        â†“
Extract Conversation Context
        â†“
Display Modal with Tones
        â†“
User Selects Tone
        â†“
Send Message to Background
        â†“
Background Builds Prompt
        â†“
Call Hugging Face API
        â†“
Parse Response
        â†“
Return 3 Replies
        â†“
Display in Modal
        â†“
User Clicks Insert
        â†“
Text Added to Input Field
```

## File Responsibilities

### manifest.json
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extension Configuration         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Name & version                â”‚
â”‚ â€¢ Permissions                   â”‚
â”‚ â€¢ Content script injection      â”‚
â”‚ â€¢ Background service worker     â”‚
â”‚ â€¢ Popup configuration           â”‚
â”‚ â€¢ Icons & resources             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### config.js
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Configuration Data              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ 11 Tone definitions           â”‚
â”‚ â€¢ AI prompts for each tone      â”‚
â”‚ â€¢ Platform selectors            â”‚
â”‚ â€¢ API settings                  â”‚
â”‚ â€¢ Model configurations          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### content.js
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Main Content Script             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GraculaAssistant Class:         â”‚
â”‚ â€¢ init()                        â”‚
â”‚ â€¢ detectPlatform()              â”‚
â”‚ â€¢ observeInputFields()          â”‚
â”‚ â€¢ attachFloatingButton()        â”‚
â”‚ â€¢ showToneSelector()            â”‚
â”‚ â€¢ extractConversationContext()  â”‚
â”‚ â€¢ handleToneSelection()         â”‚
â”‚ â€¢ generateReplies()             â”‚
â”‚ â€¢ displayReplies()              â”‚
â”‚ â€¢ insertReply()                 â”‚
â”‚ â€¢ copyReply()                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### background.js
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Background Service Worker       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Functions:                      â”‚
â”‚ â€¢ handleGenerateReplies()       â”‚
â”‚ â€¢ buildPrompt()                 â”‚
â”‚ â€¢ callAIAPI()                   â”‚
â”‚ â€¢ callHuggingFaceAPI()          â”‚
â”‚ â€¢ parseReplies()                â”‚
â”‚ â€¢ generateMockReplies()         â”‚
â”‚                                 â”‚
â”‚ Message Handlers:               â”‚
â”‚ â€¢ generateReplies               â”‚
â”‚ â€¢ updateApiConfig               â”‚
â”‚ â€¢ getApiConfig                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### styles.css
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI Styling                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Floating button styles        â”‚
â”‚ â€¢ Modal dialog styles           â”‚
â”‚ â€¢ Tone selector grid            â”‚
â”‚ â€¢ Reply cards                   â”‚
â”‚ â€¢ Loading animations            â”‚
â”‚ â€¢ Responsive design             â”‚
â”‚ â€¢ Color scheme                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### popup.html + popup.js
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Settings Interface              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ API key input                 â”‚
â”‚ â€¢ Model selection               â”‚
â”‚ â€¢ Save settings                 â”‚
â”‚ â€¢ Load settings                 â”‚
â”‚ â€¢ Feature list                  â”‚
â”‚ â€¢ Instructions                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagram

### Message Passing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Content    â”‚ â”€â”€â”€ Message â”€â”€â”€â”€â†’  â”‚  Background  â”‚
â”‚   Script     â”‚                    â”‚   Script     â”‚
â”‚              â”‚ â†â”€â”€ Response â”€â”€â”€   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†•                                    â†•
   DOM Access                          API Calls
       â†•                                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web Page    â”‚                    â”‚ Hugging Face â”‚
â”‚  (WhatsApp)  â”‚                    â”‚     API      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Storage Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Popup     â”‚
â”‚   (User)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Save Settings
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Chrome     â”‚
â”‚   Storage    â”‚
â”‚   (Sync)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Load Settings
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Background  â”‚
â”‚   Script     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Platform Detection Logic

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Platform Detection                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ Check window.location.hostname                  â”‚
â”‚         â†“                                       â”‚
â”‚ Match against config.platforms                  â”‚
â”‚         â†“                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ web.whatsapp.com    â†’ WhatsApp          â”‚   â”‚
â”‚ â”‚ instagram.com       â†’ Instagram         â”‚   â”‚
â”‚ â”‚ messenger.com       â†’ Messenger         â”‚   â”‚
â”‚ â”‚ linkedin.com        â†’ LinkedIn          â”‚   â”‚
â”‚ â”‚ twitter.com/x.com   â†’ Twitter/X         â”‚   â”‚
â”‚ â”‚ discord.com         â†’ Discord           â”‚   â”‚
â”‚ â”‚ slack.com           â†’ Slack             â”‚   â”‚
â”‚ â”‚ mail.google.com     â†’ Gmail             â”‚   â”‚
â”‚ â”‚ web.telegram.org    â†’ Telegram          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â†“                                       â”‚
â”‚ Load platform-specific selectors                â”‚
â”‚         â†“                                       â”‚
â”‚ Find input field using selectors                â”‚
â”‚         â†“                                       â”‚
â”‚ Attach floating button                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Context Extraction Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Conversation Context Extraction                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ Query DOM for message elements                  â”‚
â”‚         â†“                                       â”‚
â”‚ Use platform-specific selectors                 â”‚
â”‚         â†“                                       â”‚
â”‚ Get last 5 messages                             â”‚
â”‚         â†“                                       â”‚
â”‚ Extract text content                            â”‚
â”‚         â†“                                       â”‚
â”‚ Filter out empty/long messages                  â”‚
â”‚         â†“                                       â”‚
â”‚ Store in conversationContext array              â”‚
â”‚         â†“                                       â”‚
â”‚ Display preview in modal                        â”‚
â”‚         â†“                                       â”‚
â”‚ Send to background for AI prompt                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## AI Prompt Building

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Prompt Construction                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ Start with conversation context                 â”‚
â”‚         â†“                                       â”‚
â”‚ "Conversation context:                          â”‚
â”‚  Message 1: Hello!                              â”‚
â”‚  Message 2: How are you?                        â”‚
â”‚  Message 3: I'm good, thanks!"                  â”‚
â”‚         â†“                                       â”‚
â”‚ Add tone-specific instruction                   â”‚
â”‚         â†“                                       â”‚
â”‚ "Generate a funny, humorous response..."        â”‚
â”‚         â†“                                       â”‚
â”‚ Add formatting instruction                      â”‚
â”‚         â†“                                       â”‚
â”‚ "Generate 3 different reply options.            â”‚
â”‚  Each reply should be on a new line,            â”‚
â”‚  numbered 1., 2., and 3."                       â”‚
â”‚         â†“                                       â”‚
â”‚ Send to Hugging Face API                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Response Parsing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Response Parsing                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ Receive API response                            â”‚
â”‚         â†“                                       â”‚
â”‚ Extract generated_text field                    â”‚
â”‚         â†“                                       â”‚
â”‚ Split by newlines                               â”‚
â”‚         â†“                                       â”‚
â”‚ Match numbered patterns (1., 2., 3.)            â”‚
â”‚         â†“                                       â”‚
â”‚ Extract reply text                              â”‚
â”‚         â†“                                       â”‚
â”‚ Fallback: Split by sentences                    â”‚
â”‚         â†“                                       â”‚
â”‚ Return array of 3 replies                       â”‚
â”‚         â†“                                       â”‚
â”‚ Display in modal                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Error Handling                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ Try Hugging Face API                            â”‚
â”‚         â†“                                       â”‚
â”‚    Success? â”€â”€Yesâ”€â”€â†’ Return replies             â”‚
â”‚         â†“                                       â”‚
â”‚        No                                       â”‚
â”‚         â†“                                       â”‚
â”‚ Log error to console                            â”‚
â”‚         â†“                                       â”‚
â”‚ Use fallback mock replies                       â”‚
â”‚         â†“                                       â”‚
â”‚ Display with note about API key                 â”‚
â”‚         â†“                                       â”‚
â”‚ User can still use extension                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Security Measures                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ â€¢ Minimal permissions (activeTab, storage)      â”‚
â”‚ â€¢ No data collection or tracking               â”‚
â”‚ â€¢ API key stored in Chrome sync storage         â”‚
â”‚ â€¢ HTTPS-only API calls                          â”‚
â”‚ â€¢ Content Security Policy enforced              â”‚
â”‚ â€¢ No eval() or unsafe code execution            â”‚
â”‚ â€¢ Input sanitization (escapeHtml)               â”‚
â”‚ â€¢ XSS prevention in DOM manipulation            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance Optimizations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Performance Features                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ â€¢ Vanilla JS (no framework overhead)            â”‚
â”‚ â€¢ Lazy loading of UI elements                   â”‚
â”‚ â€¢ Efficient DOM queries                         â”‚
â”‚ â€¢ MutationObserver for dynamic content          â”‚
â”‚ â€¢ Debounced event listeners                     â”‚
â”‚ â€¢ Minimal CSS (< 10KB)                          â”‚
â”‚ â€¢ Small extension size (< 50KB)                 â”‚
â”‚ â€¢ Fast API responses (2-5 seconds)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Extension Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extension Lifecycle                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ 1. Installation                                 â”‚
â”‚    â€¢ Extension installed in Chrome              â”‚
â”‚    â€¢ Icons registered                           â”‚
â”‚    â€¢ Permissions granted                        â”‚
â”‚                                                 â”‚
â”‚ 2. Page Load                                    â”‚
â”‚    â€¢ Content script injected                    â”‚
â”‚    â€¢ Platform detected                          â”‚
â”‚    â€¢ Input field monitoring starts              â”‚
â”‚                                                 â”‚
â”‚ 3. User Interaction                             â”‚
â”‚    â€¢ Button appears on focus                    â”‚
â”‚    â€¢ Modal opens on click                       â”‚
â”‚    â€¢ Replies generated                          â”‚
â”‚    â€¢ Text inserted                              â”‚
â”‚                                                 â”‚
â”‚ 4. Background Tasks                             â”‚
â”‚    â€¢ API calls handled                          â”‚
â”‚    â€¢ Settings managed                           â”‚
â”‚    â€¢ Responses cached                           â”‚
â”‚                                                 â”‚
â”‚ 5. Updates                                      â”‚
â”‚    â€¢ Extension can be updated                   â”‚
â”‚    â€¢ Settings preserved                         â”‚
â”‚    â€¢ No data loss                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**This architecture ensures Gracula is:**
- âœ… Fast and responsive
- âœ… Secure and private
- âœ… Extensible and maintainable
- âœ… Compatible across platforms
- âœ… User-friendly and intuitive

